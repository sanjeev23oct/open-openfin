<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline';">
  <title>Tab Bar</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      font-size: 12px;
      overflow: hidden;
      background: transparent;
      -webkit-app-region: drag;
    }
    
    #tab-container {
      display: flex;
      height: 32px;
      background: linear-gradient(to bottom, #f0f0f0, #e0e0e0);
      border-bottom: 1px solid #c0c0c0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .tab {
      display: flex;
      align-items: center;
      padding: 0 12px;
      min-width: 100px;
      max-width: 200px;
      flex: 1;
      background: #e8e8e8;
      border-right: 1px solid #d0d0d0;
      cursor: pointer;
      position: relative;
      transition: background 0.15s;
      -webkit-app-region: no-drag;
    }
    
    .tab:hover {
      background: #f0f0f0;
    }
    
    .tab.active {
      background: #ffffff;
      border-bottom: 2px solid #0078d4;
    }
    
    .tab-icon {
      width: 16px;
      height: 16px;
      margin-right: 6px;
      flex-shrink: 0;
    }
    
    .tab-title {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: #333;
      font-size: 12px;
    }
    
    .tab.active .tab-title {
      font-weight: 500;
      color: #000;
    }
    
    .tab-close {
      width: 16px;
      height: 16px;
      margin-left: 6px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 3px;
      opacity: 0;
      transition: opacity 0.15s, background 0.15s;
    }
    
    .tab:hover .tab-close {
      opacity: 1;
    }
    
    .tab-close:hover {
      background: rgba(0, 0, 0, 0.1);
    }
    
    .tab-close::before {
      content: 'Ã—';
      font-size: 16px;
      line-height: 1;
      color: #666;
    }
    
    .tab-close:hover::before {
      color: #000;
    }
    
    .tab.dragging {
      opacity: 0.5;
    }
    
    .tab.drag-over {
      border-left: 2px solid #0078d4;
    }
  </style>
</head>
<body>
  <div id="tab-container"></div>
  
  <script>
    const { ipcRenderer } = require('electron');
    
    let tabs = [];
    let draggedTab = null;
    
    // Listen for tab updates
    ipcRenderer.on('tab-bar:update', (event, data) => {
      tabs = data.tabs;
      renderTabs();
    });
    
    function renderTabs() {
      const container = document.getElementById('tab-container');
      container.innerHTML = '';
      
      tabs.forEach((tab, index) => {
        const tabElement = createTabElement(tab, index);
        container.appendChild(tabElement);
      });
    }
    
    function createTabElement(tab, index) {
      const tabEl = document.createElement('div');
      tabEl.className = 'tab' + (tab.isActive ? ' active' : '');
      tabEl.dataset.windowId = tab.windowId;
      tabEl.dataset.index = index;
      tabEl.draggable = true;
      
      // Icon
      if (tab.icon) {
        const icon = document.createElement('img');
        icon.className = 'tab-icon';
        icon.src = tab.icon;
        icon.onerror = () => icon.style.display = 'none';
        tabEl.appendChild(icon);
      }
      
      // Title
      const title = document.createElement('div');
      title.className = 'tab-title';
      title.textContent = tab.title || 'Untitled';
      title.title = tab.title || 'Untitled';
      tabEl.appendChild(title);
      
      // Close button
      const closeBtn = document.createElement('div');
      closeBtn.className = 'tab-close';
      closeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        ipcRenderer.send('tab-bar:tab-close', tab.windowId);
      });
      tabEl.appendChild(closeBtn);
      
      // Tab click
      tabEl.addEventListener('click', () => {
        ipcRenderer.send('tab-bar:tab-click', tab.windowId);
      });
      
      // Drag and drop
      tabEl.addEventListener('dragstart', (e) => {
        draggedTab = tab.windowId;
        tabEl.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', tab.windowId);
        ipcRenderer.send('tab-bar:tab-drag-start', tab.windowId);
      });
      
      tabEl.addEventListener('dragend', (e) => {
        tabEl.classList.remove('dragging');
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('drag-over'));
        
        // Check if dragged outside tab bar
        const rect = document.getElementById('tab-container').getBoundingClientRect();
        if (e.clientX < rect.left || e.clientX > rect.right || 
            e.clientY < rect.top || e.clientY > rect.bottom) {
          ipcRenderer.send('tab-bar:tab-drag-end', {
            windowId: tab.windowId,
            x: e.screenX,
            y: e.screenY
          });
        }
        
        draggedTab = null;
      });
      
      tabEl.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        
        if (draggedTab && draggedTab !== tab.windowId) {
          tabEl.classList.add('drag-over');
        }
      });
      
      tabEl.addEventListener('dragleave', () => {
        tabEl.classList.remove('drag-over');
      });
      
      tabEl.addEventListener('drop', (e) => {
        e.preventDefault();
        tabEl.classList.remove('drag-over');
        
        if (draggedTab && draggedTab !== tab.windowId) {
          // Reorder tabs
          const draggedIndex = tabs.findIndex(t => t.windowId === draggedTab);
          const targetIndex = index;
          
          if (draggedIndex !== -1 && targetIndex !== -1) {
            const newTabs = [...tabs];
            const [removed] = newTabs.splice(draggedIndex, 1);
            newTabs.splice(targetIndex, 0, removed);
            
            const windowIds = newTabs.map(t => t.windowId);
            ipcRenderer.send('tab-bar:tab-reorder', windowIds);
          }
        }
      });
      
      return tabEl;
    }
  </script>
</body>
</html>
